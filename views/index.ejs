<!DOCTYPE html>
<html>
<head>
    <title>BlockHead Manager</title>
    <!-- Bootstrap for modern styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container my-4">
    <h1 class="mb-4">Website Manager</h1>
    <!-- Instruction block to clearly explain how this page works -->
    <div class="alert alert-info instructions">
        <p class="mb-1"><strong>How to manage your sites:</strong></p>
        <ul class="mb-0">
            <li><strong>Add New Site</strong> &ndash; register a domain and clone its repository. Specify the port if the app is dynamic.</li>
            <li><strong>Pull Latest</strong> &ndash; fetch updates from the site's Git repository.</li>
            <li><strong>Backup</strong> &ndash; download a zip of the site files and nginx config.</li>
            <li><strong>Configure SSL</strong> &ndash; upload certificates for HTTPS.</li>
            <li><strong>View Config</strong> &ndash; open the generated nginx server block.</li>
            <li><strong>View via IP</strong> &ndash; open the site using the server IP (<%= serverIp %>).</li>
            <li><strong>View Site</strong> &ndash; open the site using its domain name.</li>
            <li><strong>Delete</strong> &ndash; remove the entry here (does not delete files).</li>
            <li><strong>Run/Stop</strong> &ndash; run a custom command for the site, e.g. <code>npm start</code>, and stop it when needed.</li>
        </ul>
        <p class="mt-2">
            BlockHead attempts to enable Nginx automatically after a site is created.
            If you still see the default Nginx page, run
            <code>sudo ./scripts/enable_site.sh your-domain</code>
            replacing <code>your-domain</code> with the domain you added.
        </p>
        <p class="mb-0">
            Next, log in to GoDaddy and edit the DNS records for your domain.
            Create an <strong>A record</strong> pointing to <code><%= serverIp %></code>.
            Once DNS has propagated you can view the site using the buttons below.
        </p>
        <p class="mb-0">To start a site manually, enter a command such as <code>npm start</code> and press <em>Run</em>. Use <em>Stop</em> to terminate it.</p>
    </div>
    <a class="btn btn-success mb-3" href="/new">Add New Site</a>
    <!-- Quick link to the comprehensive help page -->
    <a class="btn btn-info mb-3 ms-2" href="/help">Help</a>
    <table class="table table-bordered table-striped">
        <tr>
            <th>Domain</th>
            <th>Repository</th>
            <th>Root</th>
            <th>Port</th>
            <th>Start Command</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        <% sites.forEach(function(site){ %>
        <tr>
            <td><%= site.domain %></td>
            <td><%= site.repo %></td>
            <td><%= site.root %></td>
            <td><%= site.port || '' %></td>
            <td><%= site.cmd || '' %></td>
            <td>
                <span class="status-dot <%= site.status.level %>" title="<%= site.status.message %>"></span>
                <% if (site.status.level !== 'ok') { %>
                <form action="/fix" method="post" style="display:inline">
                    <input type="hidden" name="domain" value="<%= site.domain %>" />
                    <button type="submit" class="btn btn-warning btn-sm">Fix</button>
                </form>
                <% } %>
            </td>
            <td>
                <form action="/update" method="post" style="display:inline">
                    <input type="hidden" name="domain" value="<%= site.domain %>" />
                    <button type="submit" class="btn btn-primary btn-sm">Pull Latest</button>
                </form>
                <form action="/backup" method="post" style="display:inline">
                    <input type="hidden" name="domain" value="<%= site.domain %>" />
                    <button type="submit" class="btn btn-secondary btn-sm">Backup</button>
                </form>
                <!-- Open SSL configuration page for this domain -->
                <a class="btn btn-warning btn-sm" href="/ssl/<%= site.domain %>">Configure SSL</a>
                <!-- Link to view the generated nginx config -->
                <a class="btn btn-info btn-sm" href="/config/<%= site.domain %>" target="_blank">View Config</a>
                <!-- Open the site via the server's IP address -->
                <a class="btn btn-outline-success btn-sm" href="http://<%= serverIp %>" target="_blank">View via IP</a>
                <!-- Open the site using its domain name -->
                <a class="btn btn-success btn-sm" href="http://<%= site.domain %>" target="_blank">View Site</a>
                <form action="/delete" method="post" style="display:inline" onsubmit="return confirm('Delete <%= site.domain %>?')">
                    <input type="hidden" name="domain" value="<%= site.domain %>" />
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
                <form action="/run" method="post" class="run-form mt-1 d-inline">
                    <input type="hidden" name="domain" value="<%= site.domain %>" />
                    <input type="text" name="cmd" placeholder="command" value="<%= site.cmd || '' %>" class="form-control form-control-sm" />
                    <button type="submit" class="btn btn-success btn-sm">Run</button>
                </form>
                <form action="/stop" method="post" class="mt-1 d-inline">
                    <input type="hidden" name="domain" value="<%= site.domain %>" />
                    <button type="submit" class="btn btn-warning btn-sm">Stop</button>
                </form>
            </td>
        </tr>
        <% }) %>
    </table>
    </div>
<%- include("partials/log-panel") %>
</body>
</html>
